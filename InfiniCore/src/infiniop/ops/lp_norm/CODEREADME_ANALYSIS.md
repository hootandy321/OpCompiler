# ğŸ“‚ ç›®å½•: lp_norm æ¶æ„å…¨æ™¯

## 1. å­ç³»ç»ŸèŒè´£

Lp-Normï¼ˆLp èŒƒæ•°å½’ä¸€åŒ–ï¼‰ç®—å­ç³»ç»Ÿæ˜¯ InfiniOp å¼ é‡æ“ä½œåº“ä¸­çš„æ ¸å¿ƒæ•°å€¼è®¡ç®—ç»„ä»¶ï¼Œè´Ÿè´£åœ¨æŒ‡å®šç»´åº¦ä¸Šæ‰§è¡Œ Lp èŒƒæ•°è®¡ç®—å¹¶å½’ä¸€åŒ–å¼ é‡æ•°æ®ã€‚è¯¥å­ç³»ç»Ÿå®ç°äº†æ•°å­¦è¿ç®— `y = x / (||x||_p + eps)`ï¼Œå…¶ä¸­ `||x||_p = (Î£ |x_i|^p)^(1/p)`ï¼Œå¹¿æ³›åº”ç”¨äºæ·±åº¦å­¦ä¹ ä¸­çš„å±‚å½’ä¸€åŒ–ã€æƒé‡å½’ä¸€åŒ–å’Œç‰¹å¾å½’ä¸€åŒ–åœºæ™¯ã€‚

è¯¥å­ç³»ç»Ÿé‡‡ç”¨ç¡¬ä»¶åç«¯åˆ†å±‚æ¶æ„ï¼Œé€šè¿‡ç»Ÿä¸€çš„æè¿°ç¬¦æ¥å£å±è”½ä¸åŒç¡¬ä»¶å¹³å°çš„å®ç°å·®å¼‚ï¼Œä¸ºä¸Šå±‚æ¡†æ¶æä¾›ä¸€è‡´çš„ç®—å­è°ƒç”¨æ¥å£ã€‚æ ¸å¿ƒè®¾è®¡ç†å¿µåŒ…æ‹¬ï¼šæ•°å€¼ç¨³å®šæ€§ä¼˜åŒ–ï¼ˆä¸¤é˜¶æ®µå½’ä¸€åŒ–ç­–ç•¥ï¼‰ã€å†…å­˜å¸ƒå±€è‡ªé€‚åº”ï¼ˆè¿ç»­/éè¿ç»­å¼ é‡æ”¯æŒï¼‰ã€å¹¶è¡Œå½’çº¦ç­–ç•¥ä¼˜åŒ–ï¼ˆBlock/Warp åŒè·¯å¾„ï¼‰ã€‚

## 2. æ¨¡å—å¯¼èˆª (Module Navigation)

### ğŸ“‚ cuda
- **åŠŸèƒ½**: CUDA é€šç”¨å†…æ ¸ç®—æ³•å®ç°æ¨¡å—ï¼Œæä¾›è·¨ NVIDIA GPU åç«¯çš„å¯å¤ç”¨å½’çº¦å†…æ ¸
- **èŒè´£**: å®šä¹‰ Block çº§å’Œ Warp çº§ Lp-Norm å½’çº¦çš„åº•å±‚ CUDA å†…æ ¸ç®—æ³•ï¼Œä½œä¸ºæ‰€æœ‰ NVIDIA åç«¯å®ç°çš„è®¡ç®—å¼•æ“
- **æ–‡æ¡£çŠ¶æ€**: *æ–‡æ¡£ç¼ºå¤±*

### ğŸ“‚ nvidia
- **åŠŸèƒ½**: NVIDIA GPU ä¸“ç”¨ç®—å­åç«¯å®ç°ï¼Œé’ˆå¯¹ NVIDIA ç¡¬ä»¶ç‰¹æ€§æ·±åº¦ä¼˜åŒ–çš„ CUDA ç®—å­æè¿°ç¬¦
- **èŒè´£**: å®ç° Lp-Norm æ“ä½œç¬¦çš„ NVIDIA GPU åç«¯ï¼Œæ”¯æŒ F16/F32/BF16 æ•°æ®ç±»å‹ï¼Œæä¾›è¿ç»­å†…å­˜å’Œéè¿ç»­å†…å­˜ï¼ˆstridedï¼‰å¼ é‡çš„é«˜æ€§èƒ½å¹¶è¡Œå½’çº¦ç­–ç•¥ï¼ŒåŸºäº CUB åº“å®ç° Block çº§å’Œ Warp çº§åŒè·¯å¾„å½’çº¦ç®—æ³•

## 3. æ¶æ„é€»è¾‘å›¾è§£

### 3.1 å±‚æ¬¡ç»“æ„ä¸æ•°æ®æµ

```
ä¸Šå±‚æ¡†æ¶è°ƒç”¨
    â†“
[ç»Ÿä¸€æ¥å£å±‚] lp_norm.h (å®å®šä¹‰ DESCRIPTOR)
    - å®šä¹‰ Descriptor ç±»æ¨¡æ¿
    - å£°æ˜ create() å’Œ calculate() æ¥å£
    â†“
[å…ƒæ•°æ®å±‚] info.h (LPNormInfo)
    - éªŒè¯å¼ é‡å½¢çŠ¶ã€æ­¥é•¿ã€æ•°æ®ç±»å‹
    - è®¡ç®—å½’çº¦ç»´åº¦å…ƒæ•°æ® (dimsize, othersize, stride)
    - åˆ¤æ–­å†…å­˜è¿ç»­æ€§ (continuous flag)
    â†“
[ç¡¬ä»¶åç«¯å±‚] nvidia/ (NVIDIA GPU å®ç°)
    - å®ç°å®å±•å¼€çš„ Descriptor ç±»
    - å°è£…è®¾å¤‡å¥æŸ„ (Opaque *_opaque)
    - å­˜å‚¨å…ƒæ•°æ® (LPNormInfo _info)
    - ç®¡ç†å·¥ä½œç©ºé—´ (workspace_size)
    â†“
[å†…æ ¸è°ƒåº¦å±‚] nvidia/lp_norm_nvidia.cu
    - create(): éªŒè¯å‚æ•°ï¼Œè®¡ç®—å·¥ä½œç©ºé—´ï¼Œåˆå§‹åŒ–æè¿°ç¬¦
    - calculate(): æ ¹æ® dtype å’Œ GPU æ¶æ„é€‰æ‹©å†…æ ¸
    â†“
[å†…æ ¸æ‰§è¡Œå±‚] cuda/kernel.cuh (å…±äº«å†…æ ¸åº“)
    - blockLPNormKernel(): Block çº§å½’çº¦ï¼ˆå¤§ç»´åº¦ dimsize > 1024ï¼‰
    - warpLPNormKernel(): Warp çº§å½’çº¦ï¼ˆå°ç»´åº¦ dimsize <= 1024ï¼‰
    - Strides å˜ä½“ï¼šæ”¯æŒéè¿ç»­å†…å­˜å¼ é‡ï¼ˆä»…é™æœ€åä¸€ç»´å½’çº¦ï¼‰
    â†“
CUDA GPU ç¡¬ä»¶æ‰§è¡Œ
```

### 3.2 æ¨¡å—äº¤äº’å…³ç³»

**cuda/ ä¸ nvidia/ çš„ä¾èµ–å…³ç³»**:
- `cuda/kernel.cuh` æ˜¯åº•å±‚ç®—æ³•åº“ï¼Œå®šä¹‰çº¯å†…æ ¸å‡½æ•°ï¼ˆ`__device__` å‡½æ•°ï¼‰
- `nvidia/lp_norm_nvidia.cu` æ˜¯ä¸Šå±‚è°ƒåº¦å™¨ï¼Œé€šè¿‡ `launchKernel()` å‡½æ•°åŒ…è£…å’Œè°ƒåº¦ `cuda/kernel.cuh` ä¸­çš„å†…æ ¸
- è®¾è®¡æ¨¡å¼é‡‡ç”¨"ç­–ç•¥åˆ†ç¦»"ï¼šå†…æ ¸ç®—æ³•ä¸è®¾å¤‡ç®¡ç†è§£è€¦ï¼Œä¾¿äºå¤šç¡¬ä»¶åç«¯å¤ç”¨

**info.h å…ƒæ•°æ®çš„ä¼ é€’é“¾è·¯**:
1. **éªŒè¯é˜¶æ®µ** (`LPNormInfo::createLPNormInfo()`):
   - æ£€æŸ¥è¾“å…¥/è¾“å‡ºæ•°æ®ç±»å‹ä¸€è‡´æ€§
   - éªŒè¯æœ€åä¸€ç»´æ­¥é•¿ä¸º 1ï¼ˆC é£æ ¼è¿ç»­å†…å­˜ï¼‰
   - å¤„ç†è´Ÿè½´ç´¢å¼•ï¼ˆ`axis += ndim`ï¼‰
   - è®¡ç®—å½’çº¦ç»´åº¦å¤§å°ï¼ˆ`dimsize`ï¼‰å’Œéå½’çº¦ç»´åº¦å¤§å°ï¼ˆ`othersize`ï¼‰
   - è®¡ç®—æ­¥é•¿ï¼ˆ`stride`ï¼‰ç”¨äºçº¿ç¨‹ç´¢å¼•æ˜ å°„
   - åˆ¤æ–­å†…å­˜è¿ç»­æ€§ï¼ˆ`continuous`ï¼‰ç”¨äºå†…æ ¸è·¯å¾„é€‰æ‹©

2. **æ‰§è¡Œé˜¶æ®µ** (`Descriptor::calculate()`):
   - æ ¹æ® `info.continuous` é€‰æ‹©è¿ç»­/strided å†…æ ¸åˆ†æ”¯
   - æ ¹æ® `info.dimsize` é€‰æ‹© Block/Warp å½’çº¦ç­–ç•¥ï¼ˆé˜ˆå€¼ 1024ï¼‰
   - æ ¹æ® `info.dtype` å®ä¾‹åŒ–æ¨¡æ¿å‚æ•°ï¼ˆ`half`/`float`/`__nv_bfloat16`ï¼‰

### 3.3 æ ¸å¿ƒå†³ç­–æ ‘

```
å†…æ ¸å¯åŠ¨å†³ç­–æµç¨‹
â”œâ”€â”€ 1. æ•°æ®ç±»å‹åˆ†æ”¯ (dtype)
â”‚   â”œâ”€â”€ INFINI_DTYPE_F16 â†’ launchKernel<half>()
â”‚   â”œâ”€â”€ INFINI_DTYPE_F32 â†’ launchKernel<float>()
â”‚   â””â”€â”€ INFINI_DTYPE_BF16 â†’ launchKernel<__nv_bfloat16>()
â”‚
â”œâ”€â”€ 2. å†…å­˜å¸ƒå±€åˆ†æ”¯ (continuous)
â”‚   â”œâ”€â”€ true â†’ è¿ç»­å†…å­˜è·¯å¾„ï¼ˆç›´æ¥çº¿æ€§è®¿é—®ï¼‰
â”‚   â”‚   â”œâ”€â”€ dimsize > 1024 â†’ blockLPNorm (CUB BlockReduce)
â”‚   â”‚   â””â”€â”€ dimsize <= 1024 â†’ warpLPNorm (__shfl_xor_sync)
â”‚   â”‚
â”‚   â””â”€â”€ false â†’ Strided è·¯å¾„ï¼ˆåŠ¨æ€åœ°å€è®¡ç®—ï¼‰
â”‚       â”œâ”€â”€ axis == ndim-1 (æœ€åä¸€ç»´)
â”‚       â”‚   â”œâ”€â”€ dimsize > 1024 â†’ blockLPNormStrides
â”‚       â”‚   â””â”€â”€ dimsize <= 1024 â†’ warpLPNormStrides
â”‚       â””â”€â”€ å¦åˆ™ â†’ è¿”å›é”™è¯¯ (INFINI_STATUS_BAD_PARAM)
â”‚
â””â”€â”€ 3. GPU æ¶æ„é€‚é…
    â”œâ”€â”€ maxThreadsPerBlock >= 4096 â†’ BLOCK_SIZE=4096
    â”œâ”€â”€ maxThreadsPerBlock >= 1024 â†’ BLOCK_SIZE=1024
    â””â”€â”€ maxThreadsPerBlock >= 512 â†’ BLOCK_SIZE=512
```

### 3.4 æ€§èƒ½ä¼˜åŒ–è·¯å¾„

**Block å½’çº¦è·¯å¾„** (`dimsize > 1024`):
- å¹¶è¡Œåº¦ï¼š`BLOCK_SIZE` çº¿ç¨‹ï¼ˆ512/1024/4096ï¼‰
- å½’çº¦å¼€é”€ï¼šO(log BLOCK_SIZE) æ¬¡ `__syncthreads()`
- ä¼˜åŠ¿ï¼šæœ€å¤§åŒ–çº¿ç¨‹çº§å¹¶è¡Œï¼Œé€‚åˆå¤§è§„æ¨¡å½’çº¦
- å®ç°ï¼šä½¿ç”¨ CUB åº“ `BlockReduce::Reduce()` å’Œ `BlockReduce::Sum()`

**Warp å½’çº¦è·¯å¾„** (`dimsize <= 1024`):
- å¹¶è¡Œåº¦ï¼š32 (warp å¤§å°) Ã— 32 (warp æ•°é‡) = 1024 çº¿ç¨‹
- å½’çº¦å¼€é”€ï¼šé›¶å¼€é”€ï¼ˆç¡¬ä»¶çº§ `__shfl_xor_sync` åŸè¯­ï¼‰
- ä¼˜åŠ¿ï¼šå‡å°‘å—åŒæ­¥å¼€é”€ï¼Œé€‚åˆå°/ä¸­ç»´åº¦
- å®ç°ï¼šè‡ªå®šä¹‰ `WarpAllReduce` æ¨¡æ¿å‡½æ•°ï¼Œåˆ©ç”¨ warp shuffle æŒ‡ä»¤

**Strided å†…å­˜è·¯å¾„ä¼˜åŒ–**:
- å·¥ä½œç©ºé—´é¢„åˆ†é…ï¼šä¸€æ¬¡æ€§ä¼ è¾“ `input_strides`ã€`output_strides`ã€`shape` åˆ° GPU
- åŠ¨æ€åœ°å€è®¡ç®—ï¼šé€šè¿‡æ­¥é•¿æ•°ç»„åœ¨è¿è¡Œæ—¶ç”Ÿæˆå¼ é‡ç´¢å¼•
- çº¦æŸé™åˆ¶ï¼šä»…æ”¯æŒæœ€åä¸€ç»´å½’çº¦ï¼ˆ`axis == ndim-1`ï¼‰ï¼Œé¿å…å¤æ‚çš„è·¨æ­¥è®¿é—®

### 3.5 æ•°å€¼ç¨³å®šæ€§ä¿éšœ

ä¸¤é˜¶æ®µå½’ä¸€åŒ–ç­–ç•¥é˜²æ­¢æµ®ç‚¹æ•°æº¢å‡ºï¼š

```
é˜¶æ®µ 1ï¼šæœ€å¤§å€¼å½’çº¦
  max_val = max(|x|)  (é€šè¿‡ BlockReduce/WarpAllReduce)
  x' = x / max(max_val, eps)

é˜¶æ®µ 2ï¼šLp èŒƒæ•°å½’çº¦
  ||x'||_p = (Î£ |x'|^p)^(1/p)
  y = x' / (||x'||_p + eps)
```

è¿™ç§å…ˆå½’ä¸€åŒ–åˆ° [0, 1] èŒƒå›´å†è®¡ç®—èŒƒæ•°çš„ç­–ç•¥ï¼Œæœ‰æ•ˆé¿å…äº†å¤§æ•°å€¼çš„å¹‚è¿ç®—æº¢å‡ºé—®é¢˜ã€‚

---

**æ¶æ„ç‰¹å¾**:
- **ç¡¬ä»¶åç«¯åˆ†ç¦»**: é€šç”¨å†…æ ¸ (`cuda/`) ä¸è®¾å¤‡ç®¡ç† (`nvidia/`) è§£è€¦
- **é›¶æ‹·è´ä¼˜åŒ–**: å·¥ä½œç©ºé—´å¤ç”¨ï¼Œé¿å…é‡å¤å…ƒæ•°æ®ä¼ è¾“
- **è‡ªé€‚åº”è°ƒåº¦**: æ ¹æ®æ•°æ®è§„æ¨¡ã€å†…å­˜å¸ƒå±€ã€GPU æ¶æ„åŠ¨æ€é€‰æ‹©æœ€ä¼˜å†…æ ¸
- **æ•°å€¼é²æ£’æ€§**: ä¸¤é˜¶æ®µå½’ä¸€åŒ–ç­–ç•¥ä¿è¯æµ®ç‚¹è¿ç®—ç¨³å®šæ€§

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**ç”Ÿæˆæ—¶é—´**: 2026-01-14
**æ–‡æ¡£èŒƒå›´**: ./InfiniCore/src/infiniop/ops/lp_norm
