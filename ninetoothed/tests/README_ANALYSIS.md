# ğŸ“‚ `ninetoothed/tests/` æµ‹è¯•å¥—ä»¶æ¶æ„å…¨æ™¯

## 1. å­ç³»ç»ŸèŒè´£

è¯¥ç›®å½•æ˜¯ **ninetoothed** æ¨¡å—çš„å®Œæ•´æµ‹è¯•å¥—ä»¶,è¦†ç›–ä»å•å…ƒæµ‹è¯•åˆ°é›†æˆæµ‹è¯•çš„æ‰€æœ‰æµ‹è¯•åœºæ™¯ã€‚æµ‹è¯•æ¡†æ¶åŸºäº **pytest**,é‡‡ç”¨å‚æ•°åŒ–æµ‹è¯•å’Œè‡ªåŠ¨åŒ–éšæœºç§å­ç®¡ç†,ç¡®ä¿æµ‹è¯•çš„å¯é‡ç°æ€§å’Œå…¨é¢è¦†ç›–ã€‚

ä¸»è¦èŒè´£:
- **æ ¸å¿ƒåŠŸèƒ½éªŒè¯**: éªŒè¯ç¬¦å·è®¡ç®—ã€å¼ é‡æ“ä½œã€ä»£ç ç”Ÿæˆç­‰æ ¸å¿ƒåŠŸèƒ½
- **ç¼–è¯‘æ¨¡å¼æµ‹è¯•**: è¦†ç›–JITå’ŒAOTä¸¤ç§ç¼–è¯‘æ¨¡å¼
- **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**: æµ‹è¯•å„ç§å†…å­˜å¸ƒå±€å˜æ¢ã€ç´¢å¼•æ“ä½œã€æ•°æ®ç±»å‹è½¬æ¢
- **æ€§èƒ½å›å½’æµ‹è¯•**: ç¡®ä¿ä»£ç ä¼˜åŒ–ä¸æ”¹å˜è®¡ç®—ç»“æœ
- **è·¨è®¾å¤‡æµ‹è¯•**: æ”¯æŒCPUå’ŒCUDAè®¾å¤‡çš„æµ‹è¯•

## 2. æ¨¡å—å¯¼èˆª

### æµ‹è¯•å·¥å…·æ¨¡å—
- **`conftest.py`**: pytesté…ç½®æ–‡ä»¶
  - è‡ªåŠ¨åŒ–éšæœºç§å­ç®¡ç†(åŸºäºæµ‹è¯•è·¯å¾„å“ˆå¸Œ)
  - ç¡®ä¿æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„å¯é‡ç°æ€§
  - æ”¯æŒæ¨¡å—çº§å’Œæµ‹è¯•ç”¨ä¾‹çº§çš„ç§å­è®¾ç½®

- **`utils.py`**: æµ‹è¯•è¾…åŠ©å·¥å…·
  - `get_available_devices()`: è·å–å¯ç”¨è®¾å¤‡åˆ—è¡¨(CPU/CUDA)
  - é€šç”¨æµ‹è¯•è¾…åŠ©å‡½æ•°

### æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•

#### åŸºç¡€ç®—æœ¯æ“ä½œ
- **`test_add.py`**: å‘é‡åŠ æ³•æµ‹è¯•
  - æµ‹è¯•tileæ“ä½œå’Œè‡ªåŠ¨è°ƒä¼˜
  - éªŒè¯JITç¼–è¯‘æ­£ç¡®æ€§

- **`test_addmm.py`**: çŸ©é˜µ-å‘é‡ä¹˜æ³•åŠ æ³•èåˆæµ‹è¯•
  - æµ‹è¯•å¤æ‚å¼ é‡æ“ä½œèåˆ
  - éªŒè¯å†…å­˜å¸ƒå±€ä¼˜åŒ–

- **`test_matmul.py`**: çŸ©é˜µä¹˜æ³•æµ‹è¯•
  - æµ‹è¯•å¤šç»´å¼ é‡æ“ä½œ
  - éªŒè¯åˆ†å—ä¼˜åŒ–ç­–ç•¥

- **`test_pow.py`**: å¹‚è¿ç®—æµ‹è¯•
  - æµ‹è¯•æ•°å­¦å‡½æ•°æ˜ å°„
  - éªŒè¯libdeviceå‡½æ•°è°ƒç”¨

#### å¼ é‡æ“ä½œæµ‹è¯•
- **`test_clone.py`**: å¼ é‡å…‹éš†æµ‹è¯•
  - éªŒè¯å¼ é‡å¤åˆ¶è¯­ä¹‰
  - æµ‹è¯•å†…å­˜ç‹¬ç«‹æ€§

- **`test_expand.py`**: ç»´åº¦æ‰©å±•æµ‹è¯•
  - æµ‹è¯•å•ç»´åº¦æ‰©å±•
  - éªŒè¯å¹¿æ’­è¯­ä¹‰

- **`test_unsqueeze.py`**: ç»´åº¦æ’å…¥æµ‹è¯•
  - æµ‹è¯•unsqueezeæ“ä½œ
  - éªŒè¯ç´¢å¼•æ­£ç¡®æ€§

- **`test_getitem.py`**: ç´¢å¼•æ“ä½œæµ‹è¯•
  - æµ‹è¯•å„ç§ç´¢å¼•æ–¹å¼(æ•´æ•°ã€åˆ‡ç‰‡ã€None)
  - éªŒè¯è¾¹ç•Œæ£€æŸ¥

- **`test_pad.py`**: å¡«å……æ“ä½œæµ‹è¯•
  - æµ‹è¯•å¼ é‡è¾¹ç•Œå¡«å……
  - éªŒè¯paddingå€¼æ­£ç¡®æ€§

- **`test_jagged.py`**: å˜é•¿å¼ é‡æµ‹è¯•
  - æµ‹è¯•Jagged Tensoræ”¯æŒ
  - éªŒè¯offsetså’Œseq_lenè®¡ç®—

#### é«˜çº§åŠŸèƒ½æµ‹è¯•
- **`test_aot.py`**: AOTç¼–è¯‘æµ‹è¯•
  - æµ‹è¯•æå‰ç¼–è¯‘æµç¨‹
  - éªŒè¯ç”Ÿæˆçš„Cä»£ç å’Œå¤´æ–‡ä»¶
  - æµ‹è¯•å¤šé…ç½®æ‰¹é‡æ„å»º

- **`test_jit.py`**: JITç¼–è¯‘æµ‹è¯•
  - æµ‹è¯•å³æ—¶ç¼–è¯‘æµç¨‹
  - éªŒè¯ä»£ç ç¼“å­˜æœºåˆ¶
  - æµ‹è¯•å‡½æ•°å†…è”

- **`test_generation.py`**: ä»£ç ç”Ÿæˆæµ‹è¯•
  - æµ‹è¯•ASTè½¬æ¢æ­£ç¡®æ€§
  - éªŒè¯ç”Ÿæˆçš„Tritonä»£ç 
  - æµ‹è¯•ç¬¦å·æ±‚å€¼

- **`test_eval.py`**: ç¬¦å·æ±‚å€¼æµ‹è¯•
  - æµ‹è¯•ç¬¦å·åˆ°æ•°å€¼çš„è½¬æ¢
  - éªŒè¯å¼ é‡å¸ƒå±€è®¡ç®—
  - æµ‹è¯•tileã€permuteç­‰æ“ä½œçš„ç»“æœ

- **`test_subs.py`**: ç¬¦å·æ›¿æ¢æµ‹è¯•
  - æµ‹è¯•ç¬¦å·ä»£å…¥
  - éªŒè¯æ›¿æ¢åçš„è¡¨è¾¾å¼æ­£ç¡®æ€§

#### æ·±åº¦å­¦ä¹ ç®—å­æµ‹è¯•
- **`test_conv2d.py`**: 2Då·ç§¯æµ‹è¯•
  - æµ‹è¯•å·ç§¯ç®—å­å®ç°
  - éªŒè¯æ»‘åŠ¨çª—å£æ“ä½œ

- **`test_max_pool2d.py`**: 2Dæœ€å¤§æ± åŒ–æµ‹è¯•
  - æµ‹è¯•æ± åŒ–ç®—å­
  - éªŒè¯å½’çº¦æ“ä½œ

- **`test_softmax.py`**: Softmaxæµ‹è¯•
  - æµ‹è¯•æŒ‡æ•°è¿ç®—å’Œå½’ä¸€åŒ–
  - éªŒè¯æ•°å€¼ç¨³å®šæ€§

- **`test_dropout.py`**: Dropoutæµ‹è¯•
  - æµ‹è¯•éšæœºmaskç”Ÿæˆ
  - éªŒè¯è®­ç»ƒ/æ¨ç†æ¨¡å¼åˆ‡æ¢

- **`test_attention.py`**: æ³¨æ„åŠ›æœºåˆ¶æµ‹è¯•
  - æµ‹è¯•å¤æ‚ç®—å­èåˆ
  - éªŒè¯å¤šå¤´æ³¨æ„åŠ›å®ç°

#### è°ƒè¯•ä¸å¯è§†åŒ–æµ‹è¯•
- **`test_debugging.py`**: è°ƒè¯•å·¥å…·æµ‹è¯•
  - æµ‹è¯•å¼ é‡å¸ƒå±€æ¨¡æ‹Ÿ
  - éªŒè¯ç´¢å¼•æ˜ å°„å¯è§†åŒ–

- **`test_data_ptr.py`**: æ•°æ®æŒ‡é’ˆæµ‹è¯•
  - æµ‹è¯•å†…å­˜åœ°å€è®¡ç®—
  - éªŒè¯æŒ‡é’ˆåç§»æ­£ç¡®æ€§

- **`test_naming.py`**: å‘½åçº¦å®šæµ‹è¯•
  - æµ‹è¯•ç¬¦å·å‰ç¼€ç®¡ç†
  - éªŒè¯åç§°ç”Ÿæˆè§„åˆ™

#### ç‰¹æ®Šåœºæ™¯æµ‹è¯•
- **`test_ipynb.py`**: Jupyter Notebookæµ‹è¯•
  - æµ‹è¯•åœ¨Notebookç¯å¢ƒä¸­çš„ä½¿ç”¨
  - éªŒè¯äº¤äº’å¼æ‰§è¡Œ

- **`test_clone.py`**: å…‹éš†æ“ä½œæµ‹è¯•
  - éªŒè¯å¼ é‡å¤åˆ¶è¯­ä¹‰

## 3. æµ‹è¯•è®¾è®¡æ¨¡å¼

### 3.1 å‚æ•°åŒ–æµ‹è¯•
æµ‹è¯•å¥—ä»¶å¹¿æ³›ä½¿ç”¨pytestçš„å‚æ•°åŒ–æ ‡è®°:
```python
@pytest.mark.parametrize("device", get_available_devices())
@pytest.mark.parametrize("dtype", (torch.float32,))
@pytest.mark.parametrize("size", (98432,))
def test(size, dtype, device):
    # åŒä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹åœ¨å¤šç§é…ç½®ä¸‹è¿è¡Œ
```

### 3.2 éšæœºç§å­ç®¡ç†
é€šè¿‡ `conftest.py` å®ç°:
- **æ¨¡å—çº§ç§å­**: æ¯ä¸ªæµ‹è¯•æ¨¡å—ä½¿ç”¨ä¸åŒçš„ç§å­
- **æµ‹è¯•ç”¨ä¾‹çº§ç§å­**: æ¯ä¸ªæµ‹è¯•å‡½æ•°ä½¿ç”¨ä¸åŒçš„ç§å­
- **å¯é‡ç°æ€§**: åŸºäºæµ‹è¯•è·¯å¾„çš„SHA256å“ˆå¸Œç”Ÿæˆç§å­

```python
def _hash(string):
    return int(hashlib.sha256(string.encode("utf-8")).hexdigest(), 16) % 2**32
```

### 3.3 æµ‹è¯•è¦†ç›–èŒƒå›´

| æµ‹è¯•ç±»åˆ« | è¦†ç›–åŠŸèƒ½ | æµ‹è¯•æ–‡ä»¶æ•°é‡ |
|---------|---------|------------|
| åŸºç¡€ç®—æœ¯ | åŠ æ³•ã€ä¹˜æ³•ã€å¹‚è¿ç®— | 3+ |
| å¼ é‡æ“ä½œ | ç´¢å¼•ã€åˆ‡ç‰‡ã€å½¢çŠ¶å˜æ¢ | 8+ |
| ç¼–è¯‘æ¨¡å¼ | JITã€AOTã€ä»£ç ç”Ÿæˆ | 3+ |
| æ·±åº¦å­¦ä¹ ç®—å­ | å·ç§¯ã€æ± åŒ–ã€æ³¨æ„åŠ› | 4+ |
| è°ƒè¯•å·¥å…· | å¯è§†åŒ–ã€ç¬¦å·æ±‚å€¼ | 4+ |
| ç‰¹æ®Šåœºæ™¯ | Notebookã€å˜é•¿å¼ é‡ | 3+ |

## 4. æµ‹è¯•æ‰§è¡Œ

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
pytest tests/
```

### è¿è¡Œç‰¹å®šæµ‹è¯•
```bash
pytest tests/test_add.py
pytest tests/test_aot.py -k "test_c_interface"
```

### è®¾å¤‡è¿‡æ»¤
```bash
# ä»…CPUæµ‹è¯•
pytest tests/ -k "cpu"

# ä»…CUDAæµ‹è¯•
pytest tests/ -k "cuda"
```

### å¹¶è¡Œæµ‹è¯•
```bash
pytest -n auto tests/  # ä½¿ç”¨pytest-xdistå¹¶è¡Œæ‰§è¡Œ
```

## 5. æµ‹è¯•æ•°æ®ç”Ÿæˆ

### éšæœºæ•°æ®
ä½¿ç”¨torchå’Œnumpyçš„éšæœºå‡½æ•°:
```python
input = torch.rand(size, dtype=dtype, device=device)
```

### ç¬¦å·å¼ é‡
åˆ›å»ºç¬¦å·åŒ–æµ‹è¯•å¼ é‡:
```python
x = Tensor(2, shape_options={"constexpr": True})
block_size = ninetoothed.block_size()
```

### é¢„æœŸç»“æœ
é€šå¸¸é€šè¿‡PyTorchåŸç”Ÿæ“ä½œè®¡ç®—:
```python
expected = input + other
assert torch.allclose(output, expected)
```

## 6. æµ‹è¯•æ–­è¨€ç­–ç•¥

### æ•°å€¼æ¯”è¾ƒ
ä½¿ç”¨ `torch.allclose` å¤„ç†æµ®ç‚¹è¯¯å·®:
```python
assert torch.allclose(output, expected, rtol=1e-3, atol=1e-3)
```

### å½¢çŠ¶éªŒè¯
```python
assert output.shape == expected_shape
```

### ç¬¦å·æ±‚å€¼éªŒè¯
```python
assert (x_evaluated == np.array([[0, 1, 2], ...])).all()
```

## 7. æ€§èƒ½ä¸å›å½’æµ‹è¯•

æµ‹è¯•å¥—ä»¶ä¸ä»…éªŒè¯æ­£ç¡®æ€§,è¿˜é€šè¿‡ä»¥ä¸‹æ–¹å¼ç¡®ä¿æ€§èƒ½:
- **ä»£ç ç”ŸæˆéªŒè¯**: ç¡®ä¿ç”Ÿæˆçš„å†…æ ¸ä»£ç æ­£ç¡®
- **è‡ªåŠ¨è°ƒä¼˜æµ‹è¯•**: éªŒè¯ä¸åŒé…ç½®ä¸‹çš„æ­£ç¡®æ€§
- **è¾¹ç•Œæµ‹è¯•**: æµ‹è¯•æå¤§/æå°å¼ é‡ã€ç‰¹æ®Šå½¢çŠ¶ç­‰

## 8. æŒç»­é›†æˆå…¼å®¹æ€§

æµ‹è¯•è®¾è®¡è€ƒè™‘CI/CDç¯å¢ƒ:
- **è®¾å¤‡è‡ªåŠ¨æ£€æµ‹**: åœ¨æ— GPUç¯å¢ƒè‡ªåŠ¨è·³è¿‡CUDAæµ‹è¯•
- **å¿«é€Ÿå¤±è´¥**: ä½¿ç”¨ `-x` é€‰é¡¹åœ¨é¦–æ¬¡å¤±è´¥æ—¶åœæ­¢
- **æµ‹è¯•éš”ç¦»**: æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹è¿è¡Œ,æ— çŠ¶æ€å…±äº«

## 9. æµ‹è¯•æ–‡ä»¶ç»„ç»‡

```
tests/
â”œâ”€â”€ conftest.py          # pytesté…ç½®å’Œfixture
â”œâ”€â”€ utils.py             # æµ‹è¯•è¾…åŠ©å·¥å…·
â”œâ”€â”€ test_*.py            # å•å…ƒæµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ test_add.py      # åŸºç¡€ç®—æœ¯
â”‚   â”œâ”€â”€ test_aot.py      # AOTç¼–è¯‘
â”‚   â”œâ”€â”€ test_conv2d.py   # æ·±åº¦å­¦ä¹ ç®—å­
â”‚   â””â”€â”€ ...
â””â”€â”€ __init__.py          # ç©ºæ–‡ä»¶,æ ‡è®°ä¸ºPythonåŒ…
```

## 10. æµ‹è¯•è´¨é‡æŒ‡æ ‡

- **ä»£ç è¦†ç›–ç‡**: ç›®æ ‡è¦†ç›– >90% çš„æ ¸å¿ƒä»£ç 
- **æµ‹è¯•å¯†åº¦**: æ¯ä¸ªæ ¸å¿ƒå‡½æ•°è‡³å°‘2ä¸ªæµ‹è¯•ç”¨ä¾‹
- **è®¾å¤‡è¦†ç›–**: CPUå’ŒCUDAåŒè®¾å¤‡æµ‹è¯•
- **ç±»å‹è¦†ç›–**: fp32, fp16, bf16, int32ç­‰å¤šç§æ•°æ®ç±»å‹

## 11. è°ƒè¯•å¤±è´¥çš„æµ‹è¯•

### å¯ç”¨è¯¦ç»†è¾“å‡º
```bash
pytest tests/ -v -s
```

### è¿›å…¥è°ƒè¯•å™¨
```bash
pytest tests/ --pdb
```

### ä»…è¿è¡Œå¤±è´¥æµ‹è¯•
```bash
pytest tests/ --lf  # last-failed
```

### æŸ¥çœ‹printè¾“å‡º
```bash
pytest tests/ -s  # ç¦ç”¨è¾“å‡ºæ•è·
```

## 12. æµ‹è¯•æ‰©å±•æŒ‡å—

æ·»åŠ æ–°æµ‹è¯•æ—¶:
1. åœ¨å¯¹åº”çš„ `test_*.py` æ–‡ä»¶ä¸­æ·»åŠ æµ‹è¯•å‡½æ•°
2. ä½¿ç”¨ `@pytest.mark.parametrize` å‚æ•°åŒ–æµ‹è¯•
3. ç¡®ä¿æµ‹è¯•ç‹¬ç«‹,æ— å…¨å±€çŠ¶æ€ä¾èµ–
4. ä½¿ç”¨ `assert torch.allclose` æ¯”è¾ƒæµ®ç‚¹ç»“æœ
5. åœ¨docstringä¸­è¯´æ˜æµ‹è¯•ç›®çš„

ç¤ºä¾‹æ¨¡æ¿:
```python
@pytest.mark.parametrize("device", get_available_devices())
@pytest.mark.parametrize("dtype", (torch.float32, torch.float16))
def test_new_feature(dtype, device):
    """Test new feature correctness."""
    input = torch.rand(1024, dtype=dtype, device=device)
    output = new_feature(input)
    expected = reference_implementation(input)
    assert torch.allclose(output, expected, rtol=1e-2, atol=1e-2)
```
